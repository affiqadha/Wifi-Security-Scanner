import 'models/wifi_access_point.dart';
import 'package:flutter_local_notifications/flutter_local_notifications.dart';
import 'package:flutter/material.dart';
import 'package:wifi_flutter/wifi_flutter.dart';
import 'package:permission_handler/permission_handler.dart';
import 'package:geolocator/geolocator.dart';
import 'package:provider/provider.dart';
import 'screens/wifi_scanner.dart';
import 'screens/wifi_inspector.dart';
import 'screens/device_scanner.dart';
import 'dart:async';
import 'theme/app_theme.dart';
import 'theme/theme_manager.dart';
import 'theme/background_pattern.dart';
import 'screens/mitm_detection_screen.dart';
import 'screens/education_center_screen.dart';
import 'services/mac_vendor_service.dart';
import 'screens/scan_history_screen.dart';
import 'services/preferences_service.dart';
import 'services/background_monitoring_service.dart';
import 'services/network_fingerprinting_service.dart';
import 'database/database_helper.dart';
import 'screens/onboarding_screen.dart';
import 'screens/settings_screen.dart';
import 'screens/trusted_networks_screen.dart';
import 'package:firebase_core/firebase_core.dart';
import 'services/firebase_auth_service.dart';
import 'screens/firebase_login_screen.dart';

final FlutterLocalNotificationsPlugin flutterLocalNotificationsPlugin =
    FlutterLocalNotificationsPlugin();

final GlobalKey<NavigatorState> navigatorKey = GlobalKey<NavigatorState>();

Future<void> main() async {
  WidgetsFlutterBinding.ensureInitialized();

  // ‚úÖ Initialize Firebase FIRST!
  await Firebase.initializeApp();
  print("‚úÖ Firebase initialized");

  // ‚úÖ Initialize MAC Vendor Service
  await MacVendorService.initialize();
  print("‚úÖ MAC Vendor Service initialized");

  // ‚úÖ Initialize Preferences Service
  final prefs = await PreferencesService.getInstance();
  print("‚úÖ Preferences Service initialized");

  // üî• AGGRESSIVE MODE: Set scan frequency to 1 minute
  await prefs.setScanFrequency(1);
  print("üî• Scan frequency set to 1 minute (AGGRESSIVE MODE)");

  // ‚úÖ Check authentication
  final authService = FirebaseAuthService();
  final bool isLoggedIn = authService.isLoggedIn;
  final bool showOnboarding = !prefs.hasCompletedOnboarding;
  
  print("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");
  print("üîç DEBUG: Firebase User = ${authService.currentUser}");
  print("üîç DEBUG: isLoggedIn = $isLoggedIn");
  print("üîç DEBUG: showOnboarding = $showOnboarding");
  print("‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê");


  String initialRoute;
  if (!isLoggedIn) {
    initialRoute = '/login';
    print("üîí Not logged in");
  } else if (showOnboarding) {
    initialRoute = '/onboarding';
    print("üéì Onboarding");
  } else {
    initialRoute = '/home';
    print("‚úÖ Logged in");
  }

  // ‚úÖ Initialize Database and Network Fingerprinting
  try {
    final db = await DatabaseHelper.instance.database;
    final fingerprintService = NetworkFingerprintingService();
    await fingerprintService.initialize(db);
    print("‚úÖ Network Fingerprinting Service initialized");
  } catch (e) {
    print("‚ö†Ô∏è Network Fingerprinting initialization failed: $e");
  }

  // ‚úÖ Initialize Background Monitoring Service
  try {
    final bgService = BackgroundMonitoringService();
    await bgService.initialize();
    print("‚úÖ Background Monitoring Service initialized");

    if (prefs.backgroundMonitoring) {
      await bgService.startPeriodicScanning();
      await bgService.startTimerMonitoring();
      print("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ");
      print("üî• AGGRESSIVE MODE ACTIVE");
      print("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ");
      print("   üì° Background scanning: 1 minute");
      print("   üîç Connection monitoring: 15 seconds");
      print("   ‚ö° Maximum speed for instant detection");
      print("‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ");
    }
  } catch (e) {
    print("‚ö†Ô∏è Background Monitoring initialization failed: $e");
  }

  // ‚úÖ Initialize notifications
  await flutterLocalNotificationsPlugin.initialize(
    const InitializationSettings(
      android: AndroidInitializationSettings('@mipmap/ic_launcher'),
    ),
  );

  // ‚úÖ Request location permission
  var locationStatus = await Permission.location.request();
  if (!locationStatus.isGranted) {
    WidgetsBinding.instance.addPostFrameCallback((_) {
      showDialog(
        context: navigatorKey.currentContext!,
        builder: (_) => AlertDialog(
          title: const Text("Permission Required"),
          content: const Text(
            "Location permission is required to scan Wi-Fi networks. "
            "This is an Android system requirement.",
          ),
          actions: [
            TextButton(
              onPressed: () => Navigator.pop(navigatorKey.currentContext!),
              child: const Text("OK"),
            )
          ],
        ),
      );
    });
  }

  // ‚úÖ Request notification permission (Android 13+)
  WidgetsBinding.instance.addPostFrameCallback((_) async {
    await Future.delayed(const Duration(milliseconds: 500));

    final notificationStatus = await Permission.notification.status;

    if (!notificationStatus.isGranted && navigatorKey.currentContext != null) {
      await showDialog(
        context: navigatorKey.currentContext!,
        barrierDismissible: false,
        builder: (_) => AlertDialog(
          title: const Row(
            children: [
              Icon(Icons.notifications, size: 24),
              SizedBox(width: 8),
              Text("Enable Notifications"),
            ],
          ),
          content: const Text(
            "Allow WiFense to send notifications?\n\n"
            "You'll receive real-time alerts when:\n"
            "‚Ä¢ MITM attacks are detected\n"
            "‚Ä¢ Dangerous networks are found\n"
            "‚Ä¢ Your network security is compromised",
          ),
          actions: [
            TextButton(
              onPressed: () async {
                Navigator.pop(navigatorKey.currentContext!);
                print("‚ö†Ô∏è Notification permission denied by user");
              },
              child: const Text("DENY"),
            ),
            TextButton(
              onPressed: () async {
                Navigator.pop(navigatorKey.currentContext!);
                final result = await Permission.notification.request();
                if (result.isGranted) {
                  print("‚úÖ Notification permission granted");
                } else {
                  print("‚ö†Ô∏è Notification permission denied");
                }
              },
              child: const Text("ALLOW"),
            ),
          ],
        ),
      );
    }
  });

  // Check location services
  if (!await Geolocator.isLocationServiceEnabled()) {
    print("‚ö†Ô∏è GPS is OFF. Please enable location services manually.");
  }

  runApp(
    ChangeNotifierProvider(
      create: (_) => ThemeManager(),
      child: MyApp(initialRoute: initialRoute),
    ),
  );
}

// ‚úÖ FIXED: MyApp with proper initialRoute handling
class MyApp extends StatelessWidget {
  final String initialRoute;

  const MyApp({super.key, required this.initialRoute});

  @override
  Widget build(BuildContext context) {
    return Consumer<ThemeManager>(
      builder: (context, themeManager, _) {
        return MaterialApp(
          navigatorKey: navigatorKey,
          title: 'Wifense',
          debugShowCheckedModeBanner: false,
          theme: AppTheme.lightTheme,
          darkTheme: AppTheme.darkTheme,
          themeMode: themeManager.themeMode,
          initialRoute: initialRoute,
          routes: {
            '/login': (context) => FirebaseLoginScreen(),
            '/home': (context) => const HomeScreen(),
            '/onboarding': (context) => const OnboardingScreen(),
            '/settings': (context) => const SettingsScreen(),
            '/trusted-networks': (context) => const TrustedNetworksScreen(),
            '/wifi_inspector': (context) => WifiInspectorPage(
                  wifi: ModalRoute.of(context)!.settings.arguments as WifiAccessPoint,
                ),
            '/mitm_detection': (context) => MitmDetectionScreen(),
          },
        );
      },
    );
  }
}

class HomeScreen extends StatefulWidget {
  const HomeScreen({super.key});

  @override
  State<HomeScreen> createState() => _HomeScreenState();
}

class _HomeScreenState extends State<HomeScreen> with WidgetsBindingObserver {
  String? _dangerousNetworkSsid;
  String? _dangerousNetworkEncryption;

  @override
  void initState() {
    super.initState();
    
    WidgetsBinding.instance.addObserver(this);
    
    WidgetsBinding.instance.addPostFrameCallback((_) {
      final bgService = BackgroundMonitoringService();
      bgService.setContext(context);
      print('‚úÖ Context set!');
      
      bgService.setOnDangerousNetworkDetected((network) {
        print('üì± Callback: Dangerous network detected - ${network.ssid}');
        if (mounted) {
          setState(() {
            _dangerousNetworkSsid = network.ssid;
            _dangerousNetworkEncryption = 'Open/None';
          });
        }
      });
      
      bgService.setOnDangerousNetworkCleared(() {
        print('üì± Callback: Dangerous network cleared');
        if (mounted) {
          setState(() {
            _dangerousNetworkSsid = null;
            _dangerousNetworkEncryption = null;
          });
        }
      });
      
      _checkForPendingDangerousNetwork();
    });
  }

  @override
  void dispose() {
    WidgetsBinding.instance.removeObserver(this);
    super.dispose();
  }

  @override
  void didChangeAppLifecycleState(AppLifecycleState state) {
    if (state == AppLifecycleState.resumed) {
      print('üì± App resumed - checking for dangerous network to display');
      Future.delayed(Duration(milliseconds: 300), () {
        if (mounted) {
          _checkForPendingDangerousNetwork();
        }
      });
    }
  }

  void _checkForPendingDangerousNetwork() {
    final bgService = BackgroundMonitoringService();
    final dangerous = bgService.getLastDangerousNetwork();
    
    if (dangerous != null) {
      print('üì± Showing banner for dangerous network: ${dangerous.ssid}');
      if (mounted) {
        setState(() {
          _dangerousNetworkSsid = dangerous.ssid;
          _dangerousNetworkEncryption = 'Open/None';
        });
      }
    } else {
      if (_dangerousNetworkSsid != null) {
        print('üßπ Clearing banner - no dangerous network detected');
        if (mounted) {
          setState(() {
            _dangerousNetworkSsid = null;
            _dangerousNetworkEncryption = null;
          });
        }
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    final themeManager = Provider.of<ThemeManager>(context);
    final isDarkMode = Theme.of(context).brightness == Brightness.dark;

    return BackgroundPattern(
      child: Scaffold(
        backgroundColor: Colors.transparent,
        appBar: AppBar(
          backgroundColor: Colors.transparent,
          elevation: 0,
          actions: [
            IconButton(
              icon: const Icon(Icons.settings),
              tooltip: 'Settings',
              onPressed: () {
                Navigator.pushNamed(context, '/settings');
              },
            ),
            IconButton(
              icon: Icon(isDarkMode ? Icons.light_mode : Icons.dark_mode),
              tooltip: 'Toggle Theme',
              onPressed: () {
                themeManager.toggleTheme();
              },
            ),
          ],
        ),
        body: SafeArea(
          child: SingleChildScrollView(
            child: Column(
              children: [
                if (_dangerousNetworkSsid != null && _dangerousNetworkEncryption != null)
                  Dismissible(
                    key: ValueKey('danger_banner'),
                    direction: DismissDirection.up,
                    onDismissed: (_) {
                      setState(() {
                        _dangerousNetworkSsid = null;
                        _dangerousNetworkEncryption = null;
                      });
                    },
                    child: Container(
                      width: double.infinity,
                      padding: EdgeInsets.symmetric(horizontal: 16, vertical: 12),
                      decoration: BoxDecoration(
                        gradient: LinearGradient(
                          colors: [Colors.red.shade700, Colors.red.shade900],
                          begin: Alignment.topLeft,
                          end: Alignment.bottomRight,
                        ),
                        boxShadow: [
                          BoxShadow(
                            color: Colors.red.withOpacity(0.3),
                            blurRadius: 8,
                            offset: Offset(0, 4),
                          ),
                        ],
                      ),
                      child: Column(
                        mainAxisSize: MainAxisSize.min,
                        crossAxisAlignment: CrossAxisAlignment.start,
                        children: [
                          Row(
                            children: [
                              Icon(Icons.warning_amber_rounded, color: Colors.white, size: 24),
                              SizedBox(width: 12),
                              Expanded(
                                child: Column(
                                  crossAxisAlignment: CrossAxisAlignment.start,
                                  children: [
                                    Text(
                                      "‚ö†Ô∏è UNSAFE CONNECTION",
                                      style: TextStyle(
                                        color: Colors.white,
                                        fontWeight: FontWeight.bold,
                                        fontSize: 14,
                                      ),
                                    ),
                                    SizedBox(height: 2),
                                    Text(
                                      "Connected to $_dangerousNetworkSsid without VPN",
                                      style: TextStyle(
                                        color: Colors.white.withOpacity(0.9),
                                        fontSize: 12,
                                      ),
                                    ),
                                  ],
                                ),
                              ),
                              Icon(Icons.vpn_key_off, color: Colors.white, size: 20),
                            ],
                          ),
                          SizedBox(height: 12),
                          Row(
                            children: [
                              Expanded(
                                child: ElevatedButton.icon(
                                  icon: Icon(Icons.security),
                                  label: Text("Enable VPN"),
                                  style: ElevatedButton.styleFrom(
                                    backgroundColor: Colors.white,
                                    foregroundColor: Colors.red.shade900,
                                    padding: EdgeInsets.symmetric(vertical: 8),
                                  ),
                                  onPressed: () async {
                                    final bgService = BackgroundMonitoringService();
                                    await bgService.openVPNApps();
                                  },
                                ),
                              ),
                            ],
                          ),
                        ],
                      ),
                    ),
                  ),
                
                Padding(
                  padding: const EdgeInsets.symmetric(vertical: 20.0),
                  child: Column(
                    children: [
                      Column(
                        children: [
                          const SizedBox(height: 16),
                          Image(
                            image: AssetImage(
                              isDarkMode
                                  ? 'assets/logo_light.png'
                                  : 'assets/logo_dark.png',
                            ),
                            height: 80,
                          ),
                          const SizedBox(height: 12),
                          Text(
                            'Wifense',
                            style: TextStyle(
                              color: Theme.of(context).textTheme.titleLarge?.color,
                              fontSize: 28,
                              fontWeight: FontWeight.bold,
                            ),
                          ),
                          const SizedBox(height: 30),
                        ],
                      ),
                      
                      FeatureCard(
                        icon: Icons.wifi,
                        iconBackground: const Color(0xFF4361EE),
                        title: 'Wi-Fi Scanner',
                        subtitle: 'Scan nearby Wi-Fi and inspect details.',
                        onTap: () {
                          Navigator.push(
                            context,
                            MaterialPageRoute(builder: (context) => WifiScannerScreen()),
                          );
                        },
                      ),
                      
                      FeatureCard(
                        icon: Icons.devices,
                        iconBackground: const Color(0xFF3A0CA3),
                        title: 'Connected Devices',
                        subtitle: 'See who\'s connected to your network.',
                        onTap: () {
                          Navigator.push(
                            context,
                            MaterialPageRoute(builder: (context) => DeviceScannerScreen()),
                          );
                        },
                      ),
                      
                      FeatureCard(
                        icon: Icons.security,
                        iconBackground: const Color(0xFF3F37C9),
                        title: 'MITM Attack Detection',
                        subtitle: 'Detect if someone is intercepting your data',
                        onTap: () {
                          Navigator.push(
                            context,
                            MaterialPageRoute(builder: (context) => MitmDetectionScreen()),
                          );
                        },
                      ),

                      FeatureCard(
                        icon: Icons.wifi_lock,
                        iconBackground: const Color(0xFF7209B7),
                        title: 'Trusted Networks',
                        subtitle: 'Manage trusted networks and detect Evil Twin attacks',
                        onTap: () {
                          Navigator.pushNamed(context, '/trusted-networks');
                        },
                      ),
                      
                      FeatureCard(
                        icon: Icons.school,
                        iconBackground: const Color(0xFF4CC9F0),
                        title: 'WiFi Security Academy',
                        subtitle: 'Learn about threats and how to protect yourself',
                        onTap: () {
                          Navigator.push(
                            context,
                            MaterialPageRoute(builder: (context) => EducationCenterScreen()),
                          );
                        },
                      ),
                      
                      FeatureCard(
                        icon: Icons.history,
                        iconBackground: const Color(0xFF560BAD),
                        title: 'Scan History',
                        subtitle: 'View past scans and statistics',
                        onTap: () {
                          Navigator.push(
                            context,
                            MaterialPageRoute(builder: (context) => ScanHistoryScreen()),
                          );
                        },
                      ),
                      
                      const SizedBox(height: 20),
                    ],
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}

class FeatureCard extends StatelessWidget {
  final IconData icon;
  final Color iconBackground;
  final String title;
  final String subtitle;
  final VoidCallback onTap;

  const FeatureCard({
    super.key,
    required this.icon,
    required this.iconBackground,
    required this.title,
    required this.subtitle,
    required this.onTap,
  });

  @override
  Widget build(BuildContext context) {
    final isDarkMode = Theme.of(context).brightness == Brightness.dark;

    return Padding(
      padding: const EdgeInsets.symmetric(horizontal: 16.0, vertical: 8),
      child: Card(
        elevation: 4,
        shadowColor: iconBackground.withOpacity(0.3),
        child: InkWell(
          onTap: onTap,
          borderRadius: BorderRadius.circular(16),
          child: Container(
            padding: const EdgeInsets.all(20.0),
            decoration: BoxDecoration(
              borderRadius: BorderRadius.circular(16),
              gradient: LinearGradient(
                colors: [
                  iconBackground.withOpacity(isDarkMode ? 0.05 : 0.03),
                  Colors.transparent,
                ],
                begin: Alignment.topLeft,
                end: Alignment.bottomRight,
              ),
            ),
            child: Row(
              children: [
                Container(
                  padding: const EdgeInsets.all(12),
                  decoration: BoxDecoration(
                    color: iconBackground.withOpacity(isDarkMode ? 0.8 : 0.9),
                    borderRadius: BorderRadius.circular(12),
                    boxShadow: [
                      BoxShadow(
                        color: iconBackground.withOpacity(0.3),
                        blurRadius: 8,
                        offset: const Offset(0, 2),
                      ),
                    ],
                  ),
                  child: Icon(icon, color: Colors.white, size: 26),
                ),
                const SizedBox(width: 16),
                Expanded(
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        title,
                        style: TextStyle(
                          color: Theme.of(context).textTheme.titleLarge?.color,
                          fontSize: 18,
                          fontWeight: FontWeight.bold,
                        ),
                      ),
                      const SizedBox(height: 4),
                      Text(
                        subtitle,
                        style: TextStyle(
                          color: Theme.of(context)
                              .textTheme
                              .bodyMedium
                              ?.color
                              ?.withOpacity(0.7),
                          fontSize: 14,
                        ),
                      ),
                    ],
                  ),
                ),
                Icon(
                  Icons.arrow_forward_ios,
                  size: 16,
                  color: Theme.of(context)
                      .textTheme
                      .bodySmall
                      ?.color
                      ?.withOpacity(0.5),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}

Future<void> scanAndAlert() async {
  final List<WifiNetwork> networks = (await WifiFlutter.wifiNetworks).toList();
  for (var net in networks) {
    final ssid = net.ssid;
    if (ssid.isEmpty || ssid.toLowerCase().contains("open")) {
      await showNotification(
          "‚ö†Ô∏è Suspicious Network Found", "Avoid connecting to '$ssid'");
    }
  }
}

Future<void> showNotification(String title, String message) async {
  const AndroidNotificationDetails androidDetails = AndroidNotificationDetails(
    'wifi_security_channel',
    'Wi-Fi Alerts',
    icon: '@mipmap/ic_launcher',
    importance: Importance.max,
    priority: Priority.high,
  );

  const NotificationDetails platformDetails =
      NotificationDetails(android: androidDetails);

  await flutterLocalNotificationsPlugin.show(
    0,
    title,
    message,
    platformDetails,
  );
}